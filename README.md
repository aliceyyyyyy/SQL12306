# 列国驿轨系统 - 高速铁路售票系统

一个基于 JSP 和 MySQL 的 Web 铁路售票管理系统，实现了完整的用户购票、退票、改签、换乘查询等核心功能，以及完善的后台管理系统和权限控制机制。

## 目录

- [功能特性](#功能特性)
- [技术栈](#技术栈)
- [系统要求](#系统要求)
- [快速开始](#快速开始)
- [配置说明](#配置说明)
- [项目结构](#项目结构)
- [数据库设计](#数据库设计)
- [功能模块](#功能模块)
- [使用说明](#使用说明)
- [常见问题](#常见问题)
- [许可证](#许可证)

## 功能特性

### 用户端功能
- **用户注册/登录**：支持用户注册、登录和会话管理
- **车票查询**：支持出发地、目的地、日期查询，支持直达和换乘查询
- **购票功能**：在线选座购票，自动生成电子车票
- **退票功能**：支持在线退票，自动计算手续费
- **改签功能**：支持更改车次和发车时间
- **订单管理**：查看历史购票记录和订单详情
- **车次列表**：浏览所有可用车次信息
- **权限代理**：提交权限请求，查看处理状态

### 管理端功能
- **用户管理**：用户信息管理、编辑、查询
- **车次管理**：车次信息增删改查
- **运行班次管理**：班次信息管理和库存控制
- **车票管理**：车票信息查询和管理
- **座位管理**：座位状态管理
- **权限管理**：权限请求处理和分配
- **数据统计**：支持分页查询和数据导出

## 技术栈

### 前端
- **HTML5** - 页面结构
- **CSS3** - 样式设计（中国风主题）
- **JavaScript** - 交互逻辑
- **JSP** - 服务端渲染

### 后端
- **Java** - 核心编程语言
- **JSP** - 视图层技术
- **JDBC** - 数据库连接
- **Servlet API** - Web 服务

### 数据库
- **MySQL 8.0** - 关系型数据库
- **存储过程** - 复杂查询逻辑封装
- **视图** - 数据视图抽象

### 服务器
- **Apache Tomcat 10.1.50** - Web 应用服务器

### 开发工具
- **IntelliJ IDEA** - 集成开发环境
- **MySQL Connector/J** - MySQL JDBC 驱动

## 系统要求

- **JDK**: 1.8 或更高版本
- **MySQL**: 8.0 或更高版本
- **Tomcat**: 10.1.50 或兼容版本
- **浏览器**: Chrome、Firefox、Edge 等现代浏览器
- **操作系统**: Windows、Linux、macOS

## 快速开始

### 1. 获取项目

将项目文件下载或复制到本地目录。

### 2. 数据库配置

#### 创建数据库

```sql
CREATE DATABASE wanli_12306 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE wanli_12306;
```

#### 导入数据库结构

执行项目根目录下的 SQL 脚本创建数据表、视图、存储过程等。

#### 配置数据库连接

修改各个 JSP 文件中的数据库连接信息：

```java
String url = "jdbc:mysql://localhost:3306/wanli_12306?serverTimezone=UTC&useUnicode=true&characterEncoding=UTF-8";
String username = "root";  // 修改为您的数据库用户名
String password = "your_password";  // 修改为您的数据库密码
```

**注意**：主要需要修改以下文件中的数据库连接：
- `logincheck.jsp`
- `zhucecheck.jsp`
- `buying.jsp`
- `admin/` 目录下的所有管理页面
- 其他涉及数据库操作的 JSP 文件

### 3. 部署到 Tomcat

#### 方法一：直接部署（推荐）

1. 将整个项目文件夹复制到 Tomcat 的 `webapps` 目录：
   ```
   <Tomcat根目录>/webapps/SQL12306/
   ```

2. 确保 MySQL Connector/J 驱动已放置在 `WEB-INF/lib/` 目录下

3. 启动 Tomcat 服务器

#### 方法二：打包 WAR 文件

1. 将项目打包成 WAR 文件
2. 将 WAR 文件放入 Tomcat 的 `webapps` 目录
3. 启动 Tomcat（会自动解压 WAR 文件）

### 4. 访问系统

- **用户端**: `http://localhost:8080/SQL12306/`
- **管理端**: `http://localhost:8080/SQL12306/admin/login.jsp`

默认端口为 8080，如果您的 Tomcat 配置了其他端口，请相应修改。

## 配置说明

### 数据库连接配置

系统默认数据库配置：
- **数据库名**: `wanli_12306`
- **主机**: `localhost:3306`
- **时区**: `UTC`
- **字符编码**: `UTF-8`

### 管理员账户

系统支持多角色管理员：
- **超级管理员** (`super_admin`): 拥有所有权限
- **用户管理员** (`user_admin`): 管理用户信息
- **车次管理员** (`train_admin`): 管理车次和运行班次

### 权限管理

系统使用基于角色的访问控制（RBAC）：
- 普通用户通过权限代理系统申请特殊权限
- 管理员可以处理和分配权限请求
- 详细的权限配置请参考 `权限授予说明.md`

## 项目结构

```
SQL12306/
├── admin/                      # 管理后台
│   ├── login.jsp              # 管理员登录
│   ├── user_manage.jsp        # 用户管理
│   ├── train_manage.jsp       # 车次管理
│   ├── trip_manage.jsp        # 运行班次管理
│   ├── ticket_manage.jsp      # 车票管理
│   ├── permission_requests.jsp # 权限请求管理
│   └── ...
├── css/                        # 样式文件
│   └── main.css               # 主样式表（中国风主题）
├── lib/                        # 第三方库
│   └── mysql-connector-j-release-9.x/  # MySQL JDBC 驱动
├── src/                        # Java 源代码（如需要）
├── web/                        # Web 资源
│   └── WEB-INF/
│       └── web.xml            # Web 应用配置
├── index.jsp                   # 首页
├── login.jsp                   # 用户登录
├── logincheck.jsp              # 登录验证
├── zhuce.jsp                   # 用户注册
├── loginsuccess.jsp            # 登录成功页
├── chepiaochaxun.jsp           # 车票查询
├── buying.jsp                  # 购票处理
├── tuipiao.jsp                 # 退票
├── gaipiao.jsp                 # 改签
├── huanzheng.jsp               # 换乘查询
├── searchrecord.jsp            # 订单查询
├── permission_request.jsp      # 权限请求
└── README.md                   # 项目说明文档
```

## 数据库设计

### 核心数据表

#### 1. 用户表 (user)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | VARCHAR(45) | 用户ID（主键） |
| name | VARCHAR(45) | 用户姓名 |
| password | VARCHAR(45) | 密码 |
| gender | VARCHAR(10) | 性别 |
| phone | VARCHAR(20) | 手机号 |
| id_type | VARCHAR(20) | 证件类型 |
| real_name_verified | INT | 实名验证状态 |

#### 2. 车次表 (train)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| trainnum | VARCHAR(45) | 车次号（主键） |
| origin | VARCHAR(45) | 出发地 |
| destination | VARCHAR(45) | 目的地 |
| maxmem | INT | 最大载客量 |
| normalprice | FLOAT | 标准票价 |

#### 3. 运行班次表 (trip)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| trainnum | VARCHAR(45) | 车次号（复合主键） |
| time | VARCHAR(45) | 发车时间（复合主键） |
| nowmem | INT | 当前余票数 |
| nowprice | FLOAT | 当前票价 |

#### 4. 座位表 (seat)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| seatnum | VARCHAR(45) | 座位号（复合主键） |
| trainnum | VARCHAR(45) | 车次号（复合主键） |
| time | VARCHAR(45) | 发车时间（复合主键） |
| sit | INT | 座位状态（0=空闲，1=已售） |

#### 5. 车票表 (ticket)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| ticketnum | VARCHAR(45) | 车票编号（主键） |
| seatnum | VARCHAR(45) | 座位号 |
| trainnum | VARCHAR(45) | 车次号 |
| time | VARCHAR(45) | 发车时间 |
| id | VARCHAR(45) | 用户ID |

### 存储过程

系统使用了多个存储过程来优化查询性能：
- `SEARCH_TRAIN_LIST` - 查询车次列表
- `CREATE_TICKET` - 创建车票
- `SEARCH_USER_MANAGE` - 用户管理查询
- 更多存储过程请参考 `search_procedures.sql`

详细的存储过程使用说明请参考 `搜索功能存储过程使用说明.md`。

## 功能模块

### 用户功能模块

1. **注册登录模块**
   - 用户注册（含实名验证）
   - 用户登录
   - 会话管理

2. **车票查询模块**
   - 直达车次查询
   - 换乘车次查询
   - 车次详细信息展示

3. **购票模块**
   - 座位选择
   - 在线支付（模拟）
   - 电子车票生成

4. **订单管理模块**
   - 订单查询
   - 订单详情查看
   - 历史记录

5. **退票改签模块**
   - 在线退票
   - 车票改签
   - 手续费计算

### 管理功能模块

1. **用户管理**
   - 用户信息查询（分页）
   - 用户信息编辑
   - 用户权限管理

2. **车次管理**
   - 车次信息增删改查
   - 车次价格管理

3. **运行班次管理**
   - 班次信息管理
   - 库存管理
   - 动态价格设置

4. **车票管理**
   - 车票信息查询
   - 车票统计分析

5. **权限管理**
   - 权限请求审核
   - 权限分配

## 使用说明

### 用户使用流程

1. **注册账户**
   - 访问首页，点击"用户登录"
   - 点击"立即注册"填写注册信息
   - 完成注册后返回登录页面

2. **查询车票**
   - 登录后进入首页
   - 点击"车票查询"
   - 选择出发地、目的地和日期
   - 点击查询，查看可用车次

3. **购买车票**
   - 在查询结果中选择车次
   - 选择座位
   - 确认购票信息
   - 完成购票，获得电子车票

4. **管理订单**
   - 点击"我的订单"
   - 查看所有购票记录
   - 可以退票或改签

### 管理员使用流程

1. **登录管理后台**
   - 访问 `/admin/login.jsp`
   - 使用管理员账户登录

2. **管理功能**
   - 用户管理：查看、编辑用户信息
   - 车次管理：添加、编辑车次信息
   - 班次管理：管理运行班次和库存
   - 权限管理：处理权限请求

## 常见问题

### Q1: 数据库连接失败？

**A**: 请检查以下几点：
- MySQL 服务是否已启动
- 数据库名、用户名、密码是否正确
- 端口号是否为 3306
- 是否已创建 `wanli_12306` 数据库

### Q2: Tomcat 启动失败？

**A**: 请检查：
- JDK 版本是否为 1.8 或更高
- Tomcat 端口是否被占用（默认 8080）
- `webapps` 目录权限是否正确

### Q3: 页面中文乱码？

**A**: 确保：
- 数据库字符集为 `utf8mb4`
- JSP 页面编码为 `UTF-8`
- Tomcat 的 `server.xml` 中配置了 `URIEncoding="UTF-8"`

### Q4: 无法访问管理后台？

**A**: 请确认：
- 已创建管理员账户
- 使用了正确的管理员用户名和密码
- 权限已正确配置（参考 `权限授予说明.md`）

### Q5: 存储过程执行失败？

**A**: 请参考 `搜索功能存储过程使用说明.md` 和 `权限授予说明.md`，确保：
- 存储过程已正确创建
- 用户具有执行存储过程的权限

## 开发说明

### 代码规范

- JSP 文件使用 UTF-8 编码
- Java 代码遵循驼峰命名规范
- 数据库表名和字段名使用小写
- CSS 类名使用 kebab-case（短横线分隔）

### 安全建议

⚠️ **重要提示**：当前版本中数据库密码直接写在代码中，生产环境请：
1. 使用配置文件（如 `db.properties`）存储敏感信息
2. 使用数据库连接池（如 DBCP、C3P0）
3. 对用户输入进行 SQL 注入防护（使用 PreparedStatement）
4. 实施 HTTPS 加密传输

### 性能优化

- 使用存储过程优化复杂查询
- 数据库表已建立索引
- 支持分页查询，避免一次性加载大量数据

## 更新日志

### v1.0.0
- 初始版本发布
- 完成用户端核心功能
- 完成管理端核心功能
- 实现权限管理系统
- 优化 UI 界面（中国风主题）

## 许可证

本项目采用 MIT 许可证。

## 贡献者

- 项目开发者

## 致谢

- 感谢所有为本项目提供建议和帮助的开发者
- 参考了 12306 官方网站的界面设计

---

**注意**：本项目仅用于学习和教学目的，请勿用于商业用途。

